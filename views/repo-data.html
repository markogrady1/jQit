<html>
<head>
    <title>Repository Details</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <script src="/js/external/jquery-1.11.3.min.js"></script>
    <script src="/js/external/lodash.min.js"></script>
    <script src="/js/chart.js"></script>
    <script src="/js/ajax-calls.js"></script>
    <link rel='stylesheet' href='/css/jqit.css' />
    <script src="/socket.io/socket.io.js"></script>
    <script>

        var socket = io();

         //this section of code displays how to pass a nodejs value to ejs and then on to code
         //within script tags. It can then be used anyhow you wish.
        var isIssuesHighlighted = false;
        var isPullsHighlighted = false;
        var issuesLimit = null;
        var pullsLimit = null;

        var flagdata = {};
        flagdata = <%- JSON.stringify(flagData) %>
        var username =  <%- JSON.stringify(username) %>
        var email =  <%- JSON.stringify(email) %>

         if(flagdata !== null) {

            everyIncrease = false;
            if(flagdata.show_every_increase === "true") {
               everyIncrease = true;
            } else {
               everyIncrease = false;
            }
            if(flagdata.highlight_issues_chart === "true") {

               isIssuesHighlighted = true;
               issuesLimit = flagdata.issues_boundary
            } else {
               isIssuesHighlighted = false;
            }

            if(flagdata.highlight_pulls_chart === "true") {
               isPullsHighlighted = true;
               pullsLimit = flagdata.pulls_boundary
            } else {
               isPullsHighlighted = false;
            }
         }


         console.log("Issues:",isIssuesHighlighted);
         console.log("Pulls:",isPullsHighlighted);
         console.log("Issues_boundary:",issuesLimit);
         console.log("Pulls_boundary:",pullsLimit);

         var allIssuesHistory = <%- JSON.stringify(allRepoHistory) %>
         var allPullsHistory = <%- JSON.stringify(allRepoPullsHistory) %>
         var repoData = <%- JSON.stringify(repoData) %>
         var dt = <%- JSON.stringify( fullDate) %>
         sd = dt[0].split("T")[0];
         var pdt = <%- JSON.stringify( fullPullDate) %>
         var v = <%- JSON.stringify(ch) %>

         var pr = <%- JSON.stringify(chPull) %>

         pr = pr.slice(-29) // return correct array amount for pulls history chart
         var p = <%- JSON.stringify(events) %>
         var old = <%- JSON.stringify(oldIssueUrl) %>
         var newestIssue = <%- JSON.stringify(newIssueUrl) %>
         var temp = v;
         var temp2 = pr;
         var iDiff = getDiff(v, true);
         var pDiff = getDiff(pr, false);
         var issueflagsIndexs = null;
         var pullsflagsIndexs = null;
         var startDate = dt[0].split("T")[0];
         if(flagdata !== null) {

            if(flagdata.highlight_issues_chart === "true") {
               issueflagsIndexs = checkIncrease(v, issuesLimit, everyIncrease, "issues"); //check for issues increases
            }

            if(flagdata.highlight_pulls_chart === "true") {
               pullsflagsIndexs = checkIncrease(pr, pullsLimit, everyIncrease, "pulls"); //check for issues increases
            }
         }


         console.log(iDiff + "\n",pDiff);
         console.log("issues result:",issueflagsIndexs)
         console.log("pulls result:",pullsflagsIndexs)
         var totals = getRepoPercentage(repoData);
         var foundationPullsAvg = totals.foundationPullsAverage.toFixed(2);
         var foundationIssuesAvg = totals.foundationIssuesAverage.toFixed(2);
         var issuesMonthlyAvg = getMonthAvg(v, 'issues');
         var pullsMonthlyAvg = getMonthAvg(pr, 'pulls');
      </script>
      <script src="/js/detectResize.js"></script>
      <script src="/js/external/d3.v3.min.js"></script>
      <script src="/js/external/d3.tip.v0.6.3.js"></script>
      <script src="/js/external/scrilla.js"></script>
      <style>
      </style>
   </head>
   <body>
   <% include partials/header.html %>

   <div id="top-bar">
       <ul class="top-bar-element-list">
           <li class="change-up"><div id=changeView></div></li>
           <li><div id=changeView2></div></li>
           <!--<li><div id=display-data-info></div></li>-->
           <!--<li><div class=details></div></li>-->
           <li><div class=compare-issues-info></div></li>
           <li><div class=compare-pulls-info></div></li>
       <span class="prev-issue-chart">⮂</span> <span class="next-issue-chart">⮀</span><!-- ⮀-->
       </ul>
       <a href="/">Back</a>
   </div>

      <div id=chartArea></div>
      <div id=chartArea2></div>
   <div class=compareChart></div>
   <div class=comparison-legend></div>
   <div class=multi-comparison-legend></div>

   <div class=multi-compareChart></div>
   <div class=multi-comparison></div>
      <div class='point point2'></div>
   <input class="range" value=2>
      <script>
          $chartRange = $(".range");
          $prevChartVal = $(".prev-issue-chart");
          $nextChartVal = $(".next-issue-chart");

          $prevChartVal.on("click", function() {
              getPreviousMonthViaAjax();
              var bars = document.getElementsByClassName("bars");
              var i = bars.length-1, max = 0 , delay = 10, run;
              run = function(){
                  var color = bars[i].style.fill;
                  if(i-- > max){
                      bars[i].style.fill = "rgb(0, 0, 0)";
                      setTimeout(run, delay);
                      bars[i].style.fill = color;
                  }
              };
              run();
              return false;
          });

          $nextChartVal.on("click", function() {
              getNextMonthViaAjax();
              var bars = document.getElementsByClassName("bars");
              var i =  0, max = bars.length-1, delay = 10, run;
              run = function(){
                  var color = bars[i].style.fill;
                  if(i++ < max){
                      bars[i].style.fill = "rgb(0, 0, 0)";
                      setTimeout(run, delay);
                      bars[i].style.fill = color;
                  }
              };
              run();
              return false;
          });
        var issuesArr = [], issuesArrSpare = [], pullsArr = [], pullsArrSpare = [];
        setCharts(issueflagsIndexs, pullsflagsIndexs, false);
      </script>
   <p class="attention-marker"></p>
   <p><span class="pie-link i">Issues</span> | <span class="pie-link p">Pull Requests</span></p>
   <div id="issues-pie-chart"></div>
   <div id="pulls-pie-chart"></div>
<div class="line-break"></div>
   <div class="body-wrap">
         <div class="average"></div>
         <div><b class="istatus"></b></div>
         <div><b class="pstatus"></b></div>
         <section class="item"></section>

         <h1 class=current-repo><%= data.name %></h1>
         <p><b>Repository name:</b> <%= data.name %></p>
         <p><b> GitHub Url: </b> &nbsp;<a href=<%= data.html_url %> target=_blank><%= data.html_url %></a></p>
          <!--this line below uses the calculated issues amount after subtracting the PRs from it -->
         <p><b> Open Issues: </b> <span class="openIssuesNumDisplay"></span>&nbsp;<a href=../issue/details/<%= data.name %>>Details</a></p>
         <p><b> Closed issues: </b> <%= closedissues %></p>
         <p><b> Pull Requests: </b> <%= pullRequestNo %></p>
         <p><b> Closed Pull Requests: </b> <%= closedPulls %></p>
         <p><b> Stars: </b> <%= data.watchers_count %></p>
         <p><b> Created at: </b> <%= data.created_at %></p>
         <p><b> Description: </b> <%= data.description %></p>
         <p><b> Number of forks: </b> <%= data.forks_count %></p>
         <p><b> Average time to close issues: </b> <%= avgIssues %></p>
         <p><b> Percentage of all jQuery Open Issues: </b><span class="issuesPercent"><span></p>
         <p><b> Percentage of all jQuery Open Pull Requests: </b><span class="pullsPercent"><span></p>
         <p><b> Average time to close issues: </b> <%= avgIssues %></p>
         <p class='old'>
            <b> Age of oldest issue: </b> <%= issueRange %> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <script>
                if (username !== null) {
                    $(".attention-marker").html("Mark for attention")
                }

                if(old !== null){
                    $('.old').append('<a href='+ old +' target=_blank>Go To Oldest Issue</a>');
                }

                $(".attention-marker").on("click", function() {

                    var teamname = window.location.pathname.split("/")[3];
                    $.ajax({
                        method: "POST",
                        url: "attention",
                        data: {
                            username: username,
                            email: email,
                            userAvatar: av,
                            attentionTarget: teamname
                        }
                    }).done(function(msg) {
                        console.log(msg)
                    });
                });
               $('.btn').on('click', function() {
                 if($('#chartArea').is(":visible")) {
                     $('.average').html('Month Average: ' + pullsMonthlyAvg)
                  } else if($('#chartArea').is(":hidden")) {
                      $('.average').html('Month Average: ' + issuesMonthlyAvg)
                  }
               });

            </script>
         </p>
         <p class='newest'>
            <b> Age of newest issue: </b> <%= newRange %> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <script>
               if(newestIssue !== null){
                   $('.newest').append('<a href='+ newestIssue +' target=_blank>Go To Newest Issue</a>');
               }
            </script>
         </p>
         <p><b> Average time to close pull request: </b> <%= avgPulls %></p>
         <p><b> Age of oldest pull request: </b> <%= pullRange %></p>
         <p><b>Closures: </b><br>
            <%for (var key in events){ %>
            <%= key + ' : ' + events[key] ; %> <br>
            <% } %>
         </p>
         <p></p>
         <p>Commits URL: <a href=<%= url.commits %>><%= url.commits %></a></p>

      <script>

          $(document).ready(function(){
              $(".openIssuesNumDisplay").html(v[v.length-1].issues);
          });

          var jqueryPieVal = 100 - totals.issues;
          jqueryPieVal = jqueryPieVal.toFixed(2);
          var issuesPieVal = totals.issues.toFixed(2);
          var pathname = window.location.pathname.split("/");
          var rep = pathname[3];
          // pie chart data for issues
          var pieData = [{
             "label":rep,
             "value":issuesPieVal
          },
          {
             "label":"Other jQuery repos",
             "value":jqueryPieVal
          }];
          var currentIssues = v[v.length-1].issues;
          pieChart(pieData, "#issues-pie-chart", foundationIssuesAvg, currentIssues, true);

          jqueryPieVal = 100 - totals.pulls;
          jqueryPieVal = jqueryPieVal.toFixed(2);
          var pullsPieVal = totals.pulls.toFixed(2);

          // pie chart data for PRs
          pieData = [{
                "label":rep,
                "value":pullsPieVal
             },
             {
                "label":"Other jQuery repos",
                "value":jqueryPieVal
             }];

          pieChart(pieData, "#pulls-pie-chart", foundationPullsAvg, <%= pullRequestNo %>, false);

          $(".pie-link").on("click", function() {
              if($(this).html() === "Issues") {
                  $(this).css({

                      color: "#1D214D",
                      fontWeight: "bold"
                  } );
                  $(".p").css({
                      color: "#1985E2",
                      fontWeight: "normal"

                  });
                  $("#issues-pie-chart").css("display", "block");
                  $("#pulls-pie-chart").css("display", "none");
              }
          })
          $(".pie-link").on("click", function() {
              if($(this).html() === "Pull Requests") {
                  $(this).css({

                      color: "#1D214D",
                      fontWeight: "bold"
                  } );
                  $(".i").css({
                      color: "#1985E2",
                      fontWeight: "normal"

                  });
                  $("#issues-pie-chart").css("display", "none");
                  $("#pulls-pie-chart").css("display", "block");
              }
          });



          var elm, elm2;
          elm = document.getElementsByClassName('issuesPercent');
          elm[0].innerHTML = totals.issues.toFixed(2) + "%";
          elm2 = document.getElementsByClassName('pullsPercent');
          elm2[0].innerHTML = totals.pulls.toFixed(2) + "%";
          elm3  = document.getElementsByClassName('istatus');
          elm3[0].innerHTML = iDiff;
          elm4  = document.getElementsByClassName('pstatus');
          elm4[0].innerHTML = pDiff;
         scroller.init();


      </script>

   </body>
</html>